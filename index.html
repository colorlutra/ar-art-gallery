<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ARã‚¢ãƒ¼ãƒˆã‚®ãƒ£ãƒ©ãƒªãƒ¼ - å…±åŒã‚­ãƒ£ãƒ³ãƒã‚¹</title>
    
    <!-- A-Frameã¨AR.jsã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã¿ã¾ã™ -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

    <!-- Firebaseã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firestoreãƒ­ã‚°ãƒ¬ãƒ™ãƒ«è¨­å®š (ãƒ‡ãƒãƒƒã‚°ç”¨)
        // setLogLevel('debug');

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦Firebaseã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿æŒ
        window.firebase = {};
        let authReady = false;

        // Firebaseè¨­å®šã‚’ãƒ­ãƒ¼ãƒ‰
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // FirebaseåˆæœŸåŒ–ã¨èªè¨¼
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        window.firebase.db = db;
        
        // èªè¨¼å‡¦ç†
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // èªè¨¼æ¸ˆã¿
                window.firebase.userId = user.uid;
            } else {
                // åŒ¿åã‚µã‚¤ãƒ³ã‚¤ãƒ³ã¾ãŸã¯ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ã‚¯ãƒ³èªè¨¼
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase Auth failed:", error);
                    // èªè¨¼å¤±æ•—æ™‚ã‚‚ã¨ã‚Šã‚ãˆãšãƒ©ãƒ³ãƒ€ãƒ IDã‚’ä½¿ç”¨
                    window.firebase.userId = crypto.randomUUID();
                }
            }
            authReady = true;
            console.log("Firebase Auth Ready. User ID:", window.firebase.userId);
            
            // èªè¨¼å®Œäº†å¾Œã«ãƒ‡ãƒ¼ã‚¿ç›£è¦–ã‚’é–‹å§‹
            if (window.initApp) {
                window.initApp();
            }
        });
    </script>


    <style>
        /* ARä½“é¨“ã‚’å…¨ç”»é¢è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: 'Inter', sans-serif;
            background-color: #000;
        }

        /* ARãƒ­ãƒ¼ãƒ‰ä¸­ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        #loading-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: #E0E0E0;
            padding: 20px 30px;
            border-radius: 12px;
            z-index: 999;
            font-size: 1.1rem;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        /* æç”»UIã‚³ãƒ³ãƒ†ãƒŠ */
        #drawing-ui {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 10px;
            background: rgba(20, 20, 30, 0.9);
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* UIã‚’ç”»é¢å¤–ã«éš ã™è¨­å®š */
            transform: translateY(100%);
            transition: transform 0.3s ease-out; /* ã‚¹ãƒ ãƒ¼ã‚ºãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        }

        /* UIãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ */
        #drawing-ui.open {
            transform: translateY(0);
        }


        /* æç”»ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #draw-canvas {
            touch-action: none; /* ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã®ç«¶åˆã‚’é˜²ã */
            border: 2px solid #555;
            border-radius: 8px;
            background-color: white;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3);
            cursor: crosshair;
        }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«å…¨ä½“ */
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            width: 100%;
            justify-content: center;
            align-items: center;
        }

        /* æç”»ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆè‰²ã¨ã‚µã‚¤ã‚ºï¼‰ã®ã‚³ãƒ³ãƒ†ãƒŠ */
        .drawing-options {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-right: 15px;
            padding-right: 15px;
            border-right: 1px solid #444;
        }

        /* è‰²ãƒ”ãƒƒã‚«ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #color-picker {
            width: 30px;
            height: 30px;
            padding: 0;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            outline: none;
            box-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
            /* ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ ç·šã‚’éè¡¨ç¤ºã«ã™ã‚‹ãŸã‚ */
            background-color: transparent; 
        }

        /* ã‚µã‚¤ã‚ºã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #brush-size-slider {
            width: 80px;
        }
        
        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .control-button {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            color: white;
            white-space: nowrap;
        }
        
        .control-button:active {
            transform: scale(0.98);
        }

        #save-button {
            background-color: #4CAF50; /* Green */
        }
        #save-button:hover {
            background-color: #45A049;
        }
        
        #clear-button {
            background-color: #F44336; /* Red */
        }
        #clear-button:hover {
            background-color: #E53935;
        }
        
        /* --- ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
        #toggle-drawing-button {
            position: fixed;
            bottom: 10px; /* UIãŒé–‰ã˜ã¦ã„ã‚‹ã¨ãã®åˆæœŸä½ç½® */
            right: 10px;
            z-index: 1001; /* UIã‚ˆã‚Šä¸Šã«é…ç½® */
            padding: 15px;
            border: none;
            border-radius: 50%; /* å††å½¢ã«ã™ã‚‹ */
            background-color: #3f51b5; /* Blue */
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            line-height: 1; /* ã‚¢ã‚¤ã‚³ãƒ³ã®ç¸¦ä½ç½®èª¿æ•´ */
            width: 50px; /* ãƒœã‚¿ãƒ³ã®ã‚µã‚¤ã‚ºã‚’å›ºå®š */
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #toggle-drawing-button:hover {
            background-color: #303f9f;
        }

        #toggle-drawing-button:active {
            transform: scale(0.95);
        }

        /* UIãŒé–‹ã„ã¦ã„ã‚‹ã¨ãã¯ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹ */
        #drawing-ui.open ~ #toggle-drawing-button {
            display: none;
        }
        
        /* é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ï¼ˆUIã®ä¸­ã«é…ç½®ï¼‰ */
        #close-ui-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        #close-ui-button:hover {
            opacity: 1;
        }

    </style>
</head>
<body>

    <!-- ARä½“é¨“ãƒ­ãƒ¼ãƒ‰ä¸­ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div id="loading-message">
        ARã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ä¸­...
        <br>
        ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã€å¹³ã‚‰ãªå ´æ‰€ã‚’ã‚†ã£ãã‚Šã¨æ˜ ã—ã¦ãã ã•ã„ã€‚
    </div>
    
    <!-- A-Frameã‚·ãƒ¼ãƒ³ã®è¨­å®š -->
    <a-scene 
        id="ar-scene"
        embedded 
        arjs="sourceType: webcam; trackingMethod: best; debugUIEnabled: false;"
        renderer="logarithmicDepthBuffer: true;"
    >
        <!-- 
            ã‚¢ã‚»ãƒƒãƒˆå®šç¾©ã‚¨ãƒªã‚¢: æç”»ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚’ã“ã“ã«å®šç¾©ã—ã¾ã™ã€‚
            IDã¯JavaScriptã‹ã‚‰å‹•çš„ã«ãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚½ãƒ¼ã‚¹ã¨ã—ã¦è¨­å®šã•ã‚Œã¾ã™ã€‚
        -->
        <a-assets>
            <canvas id="ar-canvas-texture" crossorigin="anonymous"></canvas>
            <!-- æç”»å†…å®¹ã‚’ARç©ºé–“ã®å¹³é¢ã«é©ç”¨ã™ã‚‹ãŸã‚ã®ãƒ†ã‚¯ã‚¹ãƒãƒ£ã€‚å‹•çš„ã«æ›´æ–°ã•ã‚Œã¾ã™ã€‚ -->
            <img id="drawing-img" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=" crossorigin="anonymous">
        </a-assets>

        <!-- 
            ARã‚¢ãƒ¼ãƒˆä½œå“ï¼ˆå¹³é¢ï¼‰ã‚’é…ç½®ã™ã‚‹ãŸã‚ã®ã‚³ãƒ³ãƒ†ãƒŠã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã€‚
            ã“ã®ä¸­ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æã„ãŸçµµãŒãƒ†ã‚¯ã‚¹ãƒãƒ£ã¨ã—ã¦é©ç”¨ã•ã‚ŒãŸå¹³é¢ã‚’å…¥ã‚Œã¾ã™ã€‚
        -->
        <a-entity id="drawing-container" position="0 0 -5" rotation="0 0 0">
            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæã„ãŸçµµã‚’è¡¨ç¤ºã™ã‚‹å¹³é¢ -->
            <a-plane 
                id="ar-drawing-plane"
                src="#drawing-img" 
                width="2" 
                height="2" 
                position="0 1 0" 
                rotation="-90 0 0" 
                shadow="receive: true; cast: true"
                color="#FFFFFF"
                material="shader: standard; metalness: 0.1; roughness: 0.8; transparent: true; opacity: 1;"
            ></a-plane>
            <a-text 
                id="drawing-label"
                value="å…±åŒARã‚­ãƒ£ãƒ³ãƒã‚¹" 
                align="center" 
                position="0 2.1 0" 
                width="5"
                color="#E0E0E0"
                rotation="-90 0 0" 
            ></a-text>

        </a-entity>

        <!-- ã‚«ãƒ¡ãƒ©ã¨ãƒ©ã‚¤ãƒˆã®è¨­å®š -->
        <a-entity light="type: ambient; color: #BBB; intensity: 0.5;"></a-entity>
        <a-entity light="type: directional; color: #FFF; intensity: 0.8; target: #ar-drawing-plane;" position="-1 5 3"></a-entity>
        
        <!-- ARä½“é¨“ã®ãŸã‚ã®ã‚«ãƒ¡ãƒ©ã€‚AR.jsã«ã‚ˆã£ã¦è‡ªå‹•çš„ã«è¨­å®šã•ã‚Œã¾ã™ã€‚ -->
        <a-entity camera></a-entity>
    </a-scene>
    
    <!-- --- æ–°è¦è¿½åŠ : æç”»UIã‚’é–‹ããƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ --- -->
    <button id="toggle-drawing-button" title="æç”»UIã‚’é–‹ã">ğŸ¨</button>

    <!-- æç”»UIã‚¨ãƒªã‚¢ -->
    <div id="drawing-ui">
        <!-- --- æ–°è¦è¿½åŠ : é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ --- -->
        <button id="close-ui-button" title="é–‰ã˜ã‚‹">âœ•</button>

        <canvas id="draw-canvas" width="300" height="200"></canvas>
        <div class="controls">
            <!-- æç”»ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆè‰²ã¨ã‚µã‚¤ã‚ºï¼‰ã‚’è¿½åŠ  -->
            <div class="drawing-options">
                <label for="color-picker" style="color: white; font-weight: bold; font-size: 0.9rem;">è‰²:</label>
                <input type="color" id="color-picker" value="#000000">
                
                <label for="brush-size-slider" style="color: white; font-weight: bold; font-size: 0.9rem;">å¤ªã•:</label>
                <input type="range" id="brush-size-slider" min="1" max="30" value="5">
                <span id="brush-size-value" style="color: #ccc; font-size: 0.9rem;">5</span>
            </div>
            
            <button id="save-button" class="control-button">ğŸ¨ ARç©ºé–“ã«åæ˜ ï¼†ä¿å­˜</button>
            <button id="clear-button" class="control-button">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
        </div>
        <p style="font-size: 0.75rem; color: #aaa; margin-top: 5px;">ã“ã®æç”»ã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨å…±æœ‰ã•ã‚Œã¾ã™</p>
    </div>

    <!-- æç”»ã¨ARåæ˜ ãƒ­ã‚¸ãƒƒã‚¯ -->
    <script>
        // æç”»é–¢é€£ã®DOMè¦ç´ 
        const drawCanvas = document.getElementById('draw-canvas');
        const ctx = drawCanvas.getContext('2d');
        const saveButton = document.getElementById('save-button');
        const clearButton = document.getElementById('clear-button');
        // è¿½åŠ ã—ãŸã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
        const colorPicker = document.getElementById('color-picker');
        const brushSizeSlider = document.getElementById('brush-size-slider');
        const brushSizeValue = document.getElementById('brush-size-value');
        
        // --- æ–°è¦è¿½åŠ /å¤‰æ›´: UIé–‹é–‰é–¢é€£ã®DOMè¦ç´  ---
        const toggleButton = document.getElementById('toggle-drawing-button');
        const drawingUI = document.getElementById('drawing-ui');
        const closeUIButton = document.getElementById('close-ui-button');
        
        // ARãƒ†ã‚¯ã‚¹ãƒãƒ£ç”¨ã®è¦ç´ 
        const arDrawingImg = document.getElementById('drawing-img');
        const arDrawingPlane = document.getElementById('ar-drawing-plane');
        const loadingMessage = document.getElementById('loading-message');

        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let brushColor = colorPicker.value; // åˆæœŸå€¤ã¯ãƒ”ãƒƒã‚«ãƒ¼ã‹ã‚‰å–å¾—
        let brushSize = parseInt(brushSizeSlider.value, 10); // åˆæœŸå€¤ã¯ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‹ã‚‰å–å¾—

        // åˆæœŸåŒ–å‡¦ç†
        function setupDrawing() {
            // åˆæœŸæç”»
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, drawCanvas.width, drawCanvas.height);
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            ctx.lineWidth = brushSize;
            ctx.strokeStyle = brushColor;
            brushSizeValue.textContent = brushSize; // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®åˆæœŸå€¤ã‚’è¡¨ç¤º

            // --- æ–°è¦è¿½åŠ : UIé–‹é–‰ã‚¤ãƒ™ãƒ³ãƒˆ ---
            toggleButton.addEventListener('click', () => toggleDrawingUI(true)); // é–‹ã
            closeUIButton.addEventListener('click', () => toggleDrawingUI(false)); // é–‰ã˜ã‚‹


            // ãƒã‚¦ã‚¹/ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            drawCanvas.addEventListener('mousedown', (e) => startDrawing(e));
            drawCanvas.addEventListener('mousemove', (e) => draw(e));
            drawCanvas.addEventListener('mouseup', () => stopDrawing());
            drawCanvas.addEventListener('mouseout', () => stopDrawing());
            
            drawCanvas.addEventListener('touchstart', (e) => {
                e.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²ã
                startDrawing(e.touches[0]);
            });
            drawCanvas.addEventListener('touchmove', (e) => {
                e.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²ã
                draw(e.touches[0]);
            });
            drawCanvas.addEventListener('touchend', () => stopDrawing());

            clearButton.addEventListener('click', clearCanvas);
            saveButton.addEventListener('click', saveDrawing);
            
            // è‰²ã¨ã‚µã‚¤ã‚ºã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            colorPicker.addEventListener('input', (e) => {
                brushColor = e.target.value;
                ctx.strokeStyle = brushColor;
            });

            brushSizeSlider.addEventListener('input', (e) => {
                brushSize = parseInt(e.target.value, 10);
                ctx.lineWidth = brushSize;
                brushSizeValue.textContent = brushSize; // å€¤ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º
            });
        }
        
        // --- æ–°è¦è¿½åŠ : æç”»UIã®é–‹é–‰æ©Ÿèƒ½ ---
        function toggleDrawingUI(shouldOpen) {
            if (shouldOpen) {
                drawingUI.classList.add('open');
            } else {
                drawingUI.classList.remove('open');
            }
        }


        // æç”»é–‹å§‹
        function startDrawing(e) {
            isDrawing = true;
            [lastX, lastY] = [e.offsetX || (e.clientX - drawCanvas.getBoundingClientRect().left), 
                              e.offsetY || (e.clientY - drawCanvas.getBoundingClientRect().top)];
            ctx.beginPath(); // æ–°ã—ã„ãƒ‘ã‚¹ã‚’é–‹å§‹
            ctx.moveTo(lastX, lastY);
            // ã‚¯ãƒªãƒƒã‚¯/ã‚¿ãƒƒãƒ—ç›´å¾Œã®ç‚¹ã‚’æç”»
            ctx.lineTo(lastX + 0.001, lastY); // ã‚ãšã‹ã«å‹•ã‹ã—ã¦ç‚¹ã‚’æç”»
            ctx.stroke();
        }

        // æç”»ä¸­
        function draw(e) {
            if (!isDrawing) return;
            // æç”»ã¯startDrawingã§beginPathã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ã“ã“ã§ã¯ãƒ©ã‚¤ãƒ³ã‚’å¼•ãã ã‘
            ctx.lineTo(e.offsetX || (e.clientX - drawCanvas.getBoundingClientRect().left), 
                       e.offsetY || (e.clientY - drawCanvas.getBoundingClientRect().top));
            ctx.stroke();
            [lastX, lastY] = [e.offsetX || (e.clientX - drawCanvas.getBoundingClientRect().left), 
                              e.offsetY || (e.clientY - drawCanvas.getBoundingClientRect().top)];
        }

        // æç”»çµ‚äº†
        function stopDrawing() {
            if (!isDrawing) return;
            isDrawing = false;
            ctx.closePath();
        }

        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ç™½ã§ã‚¯ãƒªã‚¢
        function clearCanvas() {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, drawCanvas.width, drawCanvas.height);
            // ARç©ºé–“ã«ã‚‚åæ˜ ï¼ˆä¿å­˜å‡¦ç†ã¯åˆ¥ï¼‰
            updateARTexture();
        }

        // ARãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚’æ›´æ–°
        function updateARTexture() {
            // æç”»ã‚­ãƒ£ãƒ³ãƒã‚¹ã®å†…å®¹ã‚’Base64ãƒ‡ãƒ¼ã‚¿URLã¨ã—ã¦å–å¾—
            const dataUrl = drawCanvas.toDataURL('image/png');
            
            // A-Frameã®ãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚½ãƒ¼ã‚¹ï¼ˆimgè¦ç´ ï¼‰ã‚’æ›´æ–°
            arDrawingImg.setAttribute('src', dataUrl);
            
            // A-Frameã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ ã«ãƒ†ã‚¯ã‚¹ãƒãƒ£å¤‰æ›´ã‚’é€šçŸ¥
            const material = arDrawingPlane.components.material;
            if (material) {
                material.map.needsUpdate = true;
            } else {
                // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã¯ã¾ã materialãŒãªã„å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€å†è¨­å®š
                arDrawingPlane.setAttribute('material', 'src', '#drawing-img');
            }
        }

        // Firebaseã¸ã®ä¿å­˜ã¨ARã¸ã®åæ˜ 
        async function saveDrawing() {
            if (!window.firebase || !window.firebase.db || !window.firebase.userId) {
                console.error("Firebase is not initialized or user ID is missing.");
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã®ã‚«ã‚¹ã‚¿ãƒ UIã‚’è¡¨ç¤º
                const statusMessage = document.createElement('div');
                statusMessage.textContent = 'ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼ã¨ã®æ¥ç¶šãŒç¢ºç«‹ã—ã¦ã„ã¾ã›ã‚“ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
                statusMessage.style.cssText = 'position: fixed; top: 10px; right: 10px; background: #f44336; color: white; padding: 10px; border-radius: 5px; z-index: 1001;';
                document.body.appendChild(statusMessage);
                setTimeout(() => statusMessage.remove(), 4000);
                return;
            }

            // ARãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚’æ›´æ–° (ã¾ãšãƒ­ãƒ¼ã‚«ãƒ«ã«åæ˜ )
            updateARTexture();
            
            // æç”»ãƒ‡ãƒ¼ã‚¿ã‚’Base64ã¨ã—ã¦å–å¾—
            const base64Image = drawCanvas.toDataURL('image/png');

            try {
                // Firestoreã¸ã®ä¿å­˜ãƒ‘ã‚¹ã‚’è¨­å®š
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                // Publicãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä¿å­˜ã—ã€å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§å…±æœ‰ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™
                const docRef = doc(window.firebase.db, 'artifacts', appId, 'public', 'data', 'ar_drawings', 'current_drawing');
                
                await setDoc(docRef, {
                    base64Image: base64Image,
                    artistId: window.firebase.userId,
                    timestamp: serverTimestamp(),
                    width: drawCanvas.width,
                    height: drawCanvas.height
                });
                
                console.log("Drawing successfully saved to Firestore.");
            } catch (e) {
                console.error("Error saving document: ", e);
                // ã‚«ã‚¹ã‚¿ãƒ UIã§ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
                const statusMessage = document.createElement('div');
                statusMessage.textContent = 'ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                statusMessage.style.cssText = 'position: fixed; top: 10px; right: 10px; background: #f44336; color: white; padding: 10px; border-radius: 5px; z-index: 1001;';
                document.body.appendChild(statusMessage);
                setTimeout(() => statusMessage.remove(), 4000);
            }
        }
        
        // Firestoreã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ç›£è¦–
        function startFirestoreListener() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const colRef = collection(window.firebase.db, 'artifacts', appId, 'public', 'data', 'ar_drawings');
            const docRef = doc(colRef, 'current_drawing');

            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const base64Image = data.base64Image;
                    
                    if (base64Image) {
                        console.log("New drawing received from Firestore.");
                        
                        // ç”»åƒã‚’ä¸€æ—¦imgè¦ç´ ã«ãƒ­ãƒ¼ãƒ‰ã—ã€ãã‚ŒãŒãƒ­ãƒ¼ãƒ‰å®Œäº†ã—ãŸã‚‰Canvasã«æç”»
                        const tempImg = new Image();
                        tempImg.onload = () => {
                            // å—ä¿¡ã—ãŸç”»åƒã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã®æç”»ã‚­ãƒ£ãƒ³ãƒã‚¹ã«åæ˜ 
                            ctx.drawImage(tempImg, 0, 0, drawCanvas.width, drawCanvas.height);
                            // ARãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚‚æ›´æ–°
                            updateARTexture(); 
                        };
                        tempImg.src = base64Image;
                    }
                } else {
                    console.log("No collaborative drawing found. Initializing local canvas.");
                    clearCanvas(); // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢
                }
            }, (error) => {
                console.error("Error listening to Firestore: ", error);
            });
        }


        // AR.jsãŒã‚·ãƒ¼ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‰å®Œäº†ã—ãŸã‚‰ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤ºã«ã™ã‚‹
        document.querySelector('a-scene').addEventListener('arjs-original-contents-loaded', function () {
            loadingMessage.style.display = 'none';
        });

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
        window.initApp = function() {
            setupDrawing();
            startFirestoreListener();
            updateARTexture(); // åˆæœŸãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚’ã‚»ãƒƒãƒˆ
            // ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã¯UIã‚’é–‰ã˜ãŸçŠ¶æ…‹ã«ã™ã‚‹
            toggleDrawingUI(false); 
        }

        // Firebaseã®èªè¨¼æº–å‚™ãŒæ•´ã†ã¾ã§å¾…ã¤ï¼ˆä¸Šè¨˜type="module"ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã§ã‚³ãƒ¼ãƒ«ã•ã‚Œã‚‹ï¼‰
        if (authReady) {
            window.initApp();
        }
    </script>
    
</body>
</html>
