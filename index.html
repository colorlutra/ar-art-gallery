<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ARトリックアートエディタ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- A-FrameとAR.jsの読み込み -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <!-- ar-nft.js (新しいAR.jsのフォーク) を使用すると画像トラッキング(NFT)が容易ですが、
         ここでは既存のaframe-ar.jsを維持し、カスタムパターンに切り替えます。 -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
        /* フォント設定と基本スタイル */
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; overflow: hidden; }
        
        /* A-Frameシーンのサイズ調整 */
        .a-frame-scene {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
        }

        /* ローディング画面（初期画面）のスタイル */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #1f2937; /* Dark Gray */
            color: #f3f4f6; /* Light Gray */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            transition: opacity 0.5s ease-in-out;
            font-size: 1.25rem; /* text-xl */
        }
        
        /* パレットコンテナのスタイル */
        #palette-container {
            position: fixed;
            bottom: 6rem; /* ボタンから少し上 */
            left: 1rem;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 1rem;
            padding: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            transform: translateX(-150%); /* 初期状態: 左に隠す */
            opacity: 0;
            z-index: 50;
        }

        #palette-container.open {
            transform: translateX(0); /* オープン状態: 表示 */
            opacity: 1;
        }

        /* カラーボタンのスタイル */
        .color-option {
            width: 3rem;
            height: 3rem;
            border-radius: 9999px; /* full rounded */
            border: 3px solid #f3f4f6;
            cursor: pointer;
            transition: transform 0.1s ease;
        }
        .color-option.selected {
            transform: scale(1.2);
            box-shadow: 0 0 0 3px #10b981; /* Ring around selected color */
        }

        /* パレット開閉ボタンのスタイル */
        #toggle-palette-btn {
            position: fixed;
            bottom: 1rem;
            left: 1rem;
            width: 4rem;
            height: 4rem;
            background-color: #10b981; /* Emerald */
            color: white;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 60;
            transition: background-color 0.2s, transform 0.1s;
            font-size: 1.5rem;
        }
        #toggle-palette-btn:hover {
            background-color: #059669; /* Darker Emerald */
            transform: scale(1.05);
        }

        /* その他ボタンのスタイル */
        .control-btn {
            background-color: #3b82f6; /* Blue */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .control-btn:hover {
            background-color: #2563eb;
        }

    </style>
</head>
<body>

    <!-- 1. A-Frame AR Scene -->
    <!-- Hiroマーカー依存をなくすため、a-markerのpresetをカスタムパターンに置き換えます。 -->
    <a-scene
        id="ar-scene"
        embedded
        arjs='sourceType: webcam; detectionMode: mono; cameraParametersUrl: data/camera_para.dat; debugUIEnabled: false; trackingMethod: best;'
        class="a-frame-scene"
        style="display: none;"
    >
        <!-- カメラエンティティ (必須) -->
        <a-entity camera></a-entity>

        <!-- カスタム画像マーカーのエンティティ -->
        <!-- ノーマーカーAR（平面検出など）はAR.jsの機能外ですが、Hiro以外のカスタム画像（パターン）を
             トラッキング対象とすることで、「Hiro依存」を解消し、柔軟なマーカー利用を実現します。 -->
        <!-- ※注: 'data/custom_marker.patt' は事前に作成が必要です。AR.jsのPattern Generatorを使用してください。 -->
        <a-marker id="custom-marker" type="pattern" url="data/custom_marker.patt">
            <!-- ここに配置する3Dオブジェクト -->
            <a-entity
                id="art-object"
                geometry="primitive: box; width: 0.5; height: 0.5; depth: 0.5;"
                material="color: #10b981; opacity: 0.8;"
                position="0 0.25 0"
                rotation="0 45 0"
            ></a-entity>
        </a-marker>
    </a-scene>

    <!-- 2. ローディング/開始画面 -->
    <div id="loading-screen">
        <h1 class="text-3xl font-bold mb-4">ARトリックアート制作アプリ</h1>
        <p class="mb-2 text-center max-w-sm">「Hiro」ではなく、**カスタム画像マーカー**を認識します。</p>
        <p class="mb-8 text-sm text-gray-400">（カスタム画像に対応する`data/custom_marker.patt`ファイルが必要です）</p>
        <button id="start-ar-btn" class="control-btn">ARを開始</button>
    </div>

    <!-- 3. UIコントロール -->
    <!-- パレット開閉ボタン (左下) -->
    <button id="toggle-palette-btn" style="display: none;">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-8 h-8">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 0 0-5.78 1.128 2.25 2.25 0 0 1-2.4 2.222l-1.318-.795A2.25 2.25 0 0 0 .5 21.318v1.317a.75.75 0 0 0 1.5 0v-1.317a3 3 0 0 1 3.2-2.926 3 3 0 0 0 5.09-1.802zM19.953 4.228a1.5 1.5 0 0 1 1.058 1.968l-1.41 4.793a1.5 1.5 0 0 1-2.229.83L14.49 9.872a1.5 1.5 0 0 1-.83-2.23l1.41-4.793a1.5 1.5 0 0 1 1.967-1.058zM12 7.75a4 4 0 1 0 0 8 4 4 0 0 0 0-8z" />
        </svg>
    </button>

    <!-- カラーパレットコンテナ -->
    <div id="palette-container">
        <div class="text-sm font-semibold mb-2 text-gray-700">オブジェクトの色</div>
        <div id="color-options" class="flex flex-wrap gap-2 justify-center">
            <!-- カラーオプションはJSで生成 -->
        </div>
    </div>
    
    <script>
        // グローバル変数
        let currentArtObject;
        let selectedColor = '#10b981'; // 初期色

        const COLORS = [
            '#ef4444', // Red
            '#f97316', // Orange
            '#fbbf24', // Yellow
            '#22c55e', // Green
            '#10b981', // Emerald (Default)
            '#3b82f6', // Blue
            '#8b5cf6', // Violet
            '#ec4899', // Pink
            '#6b7280', // Gray
            '#000000'  // Black
        ];

        document.addEventListener('DOMContentLoaded', () => {
            const arScene = document.getElementById('ar-scene');
            const loadingScreen = document.getElementById('loading-screen');
            const startArBtn = document.getElementById('start-ar-btn');
            const togglePaletteBtn = document.getElementById('toggle-palette-btn');
            const paletteContainer = document.getElementById('palette-container');
            const colorOptionsDiv = document.getElementById('color-options');
            
            // カスタムマーカーエンティティ内のアートオブジェクトを取得
            const marker = document.getElementById('custom-marker');
            currentArtObject = document.getElementById('art-object');
            
            // 1. AR開始処理
            startArBtn.addEventListener('click', () => {
                loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                    arScene.style.display = 'block';
                    togglePaletteBtn.style.display = 'flex';
                    // A-FrameとAR.jsの初期化トリガー
                    arScene.dispatchEvent(new CustomEvent('render-target-loaded'));
                }, 500);
            });

            // 2. パレット開閉処理
            togglePaletteBtn.addEventListener('click', () => {
                paletteContainer.classList.toggle('open');
            });

            // 3. カラーパレットの生成とイベントリスナー
            function renderColorOptions() {
                colorOptionsDiv.innerHTML = '';
                COLORS.forEach(color => {
                    const btn = document.createElement('div');
                    btn.className = 'color-option';
                    btn.style.backgroundColor = color;
                    btn.dataset.color = color;
                    
                    if (color === selectedColor) {
                        btn.classList.add('selected');
                    }

                    btn.addEventListener('click', () => {
                        selectedColor = color;
                        // 選択された色を3Dオブジェクトに適用
                        if (currentArtObject) {
                            currentArtObject.setAttribute('material', 'color', selectedColor);
                        }
                        // UIの選択状態を更新
                        document.querySelectorAll('.color-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        btn.classList.add('selected');
                        // 色選択後、パレットを自動的に閉じる
                        paletteContainer.classList.remove('open');
                    });
                    colorOptionsDiv.appendChild(btn);
                });
            }

            // A-Frameがロードされた後にカラーパレットを初期化
            arScene.addEventListener('loaded', () => {
                // カスタムマーカーが認識された際のイベントリスナー
                marker.addEventListener('markerFound', () => {
                    console.log('カスタムマーカーが見つかりました。');
                    // マーカーが見つかったら、オブジェクトを現在の色で再設定
                    currentArtObject.setAttribute('material', 'color', selectedColor);
                });

                marker.addEventListener('markerLost', () => {
                    console.log('カスタムマーカーが見失われました。');
                });
                
                // 初期のカラーパレット表示
                renderColorOptions();
                
            });
            
            // 初期のパレットオプションを生成 (AR.jsロード前に実行される可能性も考慮)
            renderColorOptions();

            // 4. トリックアートの形状切り替え機能 (将来的な拡張のために残す)
            // 現在は立方体のみ

            // 5. カメラアクセスエラー処理 (任意)
            arScene.addEventListener('arjs-error', (e) => {
                console.error('AR.js Error:', e.detail);
                // エラーメッセージをユーザーに表示する処理などをここに追加
                loadingScreen.style.display = 'flex';
                loadingScreen.innerHTML = '<h1 class="text-3xl font-bold mb-4 text-red-500">エラー</h1><p>ARカメラの初期化に失敗しました。カメラのアクセス許可を確認してください。</p>';
            });

            // マーカーのデバッグ表示を無効化することで、マーカーの上にオブジェクトのみが表示されます。
        });
    </script>
</body>
</html>
