<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ARã‚¢ãƒ¼ãƒˆã‚®ãƒ£ãƒ©ãƒªãƒ¼ - å…±åŒã‚­ãƒ£ãƒ³ãƒã‚¹</title>
    
    <!-- A-Frameã¨AR.jsã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã¿ã¾ã™ -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

    <!-- Firebaseã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // å¿…è¦ãªFirestoreé–¢æ•°ã‚’å…¨ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { getFirestore, doc, setDoc, onSnapshot, collection, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦Firebaseã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¨é–¢æ•°ã‚’ä¿æŒ
        window.firebase = {};
        window.firebase.doc = doc;
        window.firebase.setDoc = setDoc;
        window.firebase.onSnapshot = onSnapshot;
        window.firebase.collection = collection;
        window.firebase.serverTimestamp = serverTimestamp;
        
        let authReady = false;

        // Firebaseè¨­å®šã‚’ãƒ­ãƒ¼ãƒ‰
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // FirebaseåˆæœŸåŒ–ã¨èªè¨¼
        const app = initializeApp(firebaseConfig);
        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’æœ‰åŠ¹åŒ–
        setLogLevel('debug');
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        window.firebase.db = db;
        
        // èªè¨¼å‡¦ç†
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // èªè¨¼æ¸ˆã¿
                window.firebase.userId = user.uid;
            } else {
                // åŒ¿åã‚µã‚¤ãƒ³ã‚¤ãƒ³ã¾ãŸã¯ã‚«ã‚¹ã‚¿ãƒ ãƒˆãƒ¼ã‚¯ãƒ³èªè¨¼
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        const anonUser = await signInAnonymously(auth);
                        window.firebase.userId = anonUser.user.uid;
                    }
                } catch (error) {
                    console.error("Firebase Auth failed:", error);
                    // èªè¨¼å¤±æ•—æ™‚ã‚‚ã¨ã‚Šã‚ãˆãšãƒ©ãƒ³ãƒ€ãƒ IDã‚’ä½¿ç”¨
                    window.firebase.userId = crypto.randomUUID();
                }
            }
            authReady = true;
            console.log("Firebase Auth Ready. User ID:", window.firebase.userId);
            
            // èªè¨¼å®Œäº†å¾Œã«ãƒ‡ãƒ¼ã‚¿ç›£è¦–ã‚’é–‹å§‹
            if (window.initApp) {
                window.initApp();
            }
        });
    </script>


    <style>
        /* ARä½“é¨“ã‚’å…¨ç”»é¢è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: 'Inter', sans-serif;
            background-color: #000;
        }

        /* ARãƒ­ãƒ¼ãƒ‰ä¸­ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        #loading-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: #E0E0E0;
            padding: 20px 30px;
            border-radius: 12px;
            z-index: 999;
            font-size: 1.1rem;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            transition: opacity 0.5s ease; /* ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆç”¨ */
        }
        
        /* æç”»UIã‚³ãƒ³ãƒ†ãƒŠ */
        #drawing-ui {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            /* æç”»UIã®æœ€å¤§å¹…ã‚’900pxã«æ‹¡å¤§ */
            max-width: 900px; 
            margin: 0 auto;
            right: 0; /* max-widthã¨ä½µç”¨ã—ã¦ä¸­å¤®å¯„ã› */
            
            padding: 10px;
            background: rgba(20, 20, 30, 0.95);
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* UIã‚’ç”»é¢å¤–ã«éš ã™è¨­å®š (åˆæœŸçŠ¶æ…‹) */
            transform: translateY(100%);
            transition: transform 0.3s ease-out; /* ã‚¹ãƒ ãƒ¼ã‚ºãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
        }

        /* UIãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ */
        #drawing-ui.open {
            transform: translateY(0);
        }


        /* æç”»ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
        #draw-canvas {
            /* ä¿®æ­£ç‚¹: ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆãŒã‚­ãƒ£ãƒ³ãƒã‚¹ã«ç¢ºå®Ÿã«å±Šãã‚ˆã† 'none'ã‚’è¨­å®š */
            touch-action: none; 
            /* æœ€å¤§å¹…ã‚’ã‚³ãƒ³ãƒ†ãƒŠã‚µã‚¤ã‚ºã«åˆã‚ã›ã‚‹ */
            max-width: calc(100% - 20px); 
            height: auto; 
            /* ã‚­ãƒ£ãƒ³ãƒã‚¹ã®å¹…ã«åˆã‚ã›ã‚‹ãŸã‚ã«blockè¦ç´ ã«ã™ã‚‹ */
            display: block; 
            border: 2px solid #555;
            border-radius: 8px;
            background-color: white;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3);
            cursor: crosshair;
        }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«å…¨ä½“ */
        .controls {
            display: flex;
            flex-wrap: wrap; /* å°ã•ã„ç”»é¢ã§æŠ˜ã‚Šè¿”ã™ */
            gap: 10px;
            margin-top: 10px;
            width: 100%;
            padding: 0 5px;
            justify-content: center;
            align-items: center;
        }

        /* æç”»ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆè‰²ã¨ã‚µã‚¤ã‚ºï¼‰ã®ã‚³ãƒ³ãƒ†ãƒŠ */
        .drawing-options {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 5px 15px;
            border-right: 1px solid #444;
        }
        
        /* ãƒ¢ãƒã‚¤ãƒ«ã§ã®èª¿æ•´ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’900pxã«åˆã‚ã›ã‚‹ */
        @media (max-width: 900px) { 
            .controls {
                flex-direction: column;
            }
            .drawing-options {
                border-right: none;
                border-bottom: 1px solid #444;
                padding-bottom: 10px;
                margin-bottom: 5px;
                width: 100%;
                justify-content: center;
            }
            .control-button {
                width: 100%;
            }
        }


        /* è‰²ãƒ”ãƒƒã‚«ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #color-picker {
            width: 30px;
            height: 30px;
            padding: 0;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            outline: none;
            box-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
            background-color: transparent; 
        }

        /* ã‚µã‚¤ã‚ºã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #brush-size-slider {
            width: 80px;
        }
        
        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .control-button {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            color: white;
            white-space: nowrap;
        }
        
        .control-button:active {
            transform: scale(0.98);
        }

        #save-button {
            background-color: #4CAF50; /* Green */
        }
        #save-button:hover {
            background-color: #45A049;
        }
        
        #clear-button {
            background-color: #F44336; /* Red */
        }
        #clear-button:hover {
            background-color: #E53935;
        }
        
        /* --- ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
        #toggle-drawing-button {
            position: fixed;
            bottom: 10px; /* UIãŒé–‰ã˜ã¦ã„ã‚‹ã¨ãã®åˆæœŸä½ç½® */
            right: 10px;
            z-index: 1001; /* UIã‚ˆã‚Šä¸Šã«é…ç½® */
            padding: 15px;
            border: none;
            border-radius: 50%; /* å††å½¢ã«ã™ã‚‹ */
            background-color: #3f51b5; /* Blue */
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            line-height: 1; /* ã‚¢ã‚¤ã‚³ãƒ³ã®ç¸¦ä½ç½®èª¿æ•´ */
            width: 50px; /* ãƒœã‚¿ãƒ³ã®ã‚µã‚¤ã‚ºã‚’å›ºå®š */
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #toggle-drawing-button:hover {
            background-color: #303f9f;
        }

        #toggle-drawing-button:active {
            transform: scale(0.95);
        }

        /* UIãŒé–‹ã„ã¦ã„ã‚‹ã¨ãã¯ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹ */
        #drawing-ui.open ~ #toggle-drawing-button {
            display: none;
        }
        
        /* é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ï¼ˆUIã®ä¸­ã«é…ç½®ï¼‰ */
        #close-ui-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        #close-ui-button:hover {
            opacity: 1;
        }

    </style>
</head>
<body>

    <!-- ARä½“é¨“ãƒ­ãƒ¼ãƒ‰ä¸­ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div id="loading-message">
        ARã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ä¸­...
        <br>
        ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã€å¹³ã‚‰ãªå ´æ‰€ã‚’ã‚†ã£ãã‚Šã¨æ˜ ã—ã¦ãã ã•ã„ã€‚
    </div>
    
    <!-- A-Frameã‚·ãƒ¼ãƒ³ã®è¨­å®š -->
    <a-scene 
        id="ar-scene"
        embedded 
        arjs="sourceType: webcam; trackingMethod: best; debugUIEnabled: false; 
              sourceWidth: 1280; sourceHeight: 720; displayWidth: 1280; displayHeight: 720;" 
        renderer="logarithmicDepthBuffer: true;"
    >
        <!-- 
            ã‚¢ã‚»ãƒƒãƒˆå®šç¾©ã‚¨ãƒªã‚¢: æç”»ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚’ã“ã“ã«å®šç¾©ã—ã¾ã™ã€‚
            NOTE: æç”»ã‚­ãƒ£ãƒ³ãƒã‚¹è‡ªä½“ã‚’ãƒ†ã‚¯ã‚¹ãƒãƒ£ã¨ã—ã¦ç›´æ¥å‚ç…§ã™ã‚‹ãŸã‚ã€ä¸­é–“çš„ãª<img>ã¯ä¸è¦ã«ãªã‚Šã¾ã—ãŸã€‚
        -->
        <a-assets>
            <!-- æç”»ã‚­ãƒ£ãƒ³ãƒã‚¹IDã‚’ãƒ†ã‚¯ã‚¹ãƒãƒ£ã¨ã—ã¦å‚ç…§ã—ã¾ã™ -->
            <!-- <canvas id="ar-canvas-texture" crossorigin="anonymous"></canvas> -->
            <!-- <img id="drawing-img" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=" crossorigin="anonymous"> -->
        </a-assets>

        <!-- 
            ARã‚¢ãƒ¼ãƒˆä½œå“ï¼ˆå¹³é¢ï¼‰ã‚’é…ç½®ã™ã‚‹ãŸã‚ã®ã‚³ãƒ³ãƒ†ãƒŠã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã€‚
        -->
        <a-entity id="drawing-container" position="0 0 -5" rotation="0 0 0">
            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæã„ãŸçµµã‚’è¡¨ç¤ºã™ã‚‹å¹³é¢ -->
            <a-plane 
                id="ar-drawing-plane"
                src="#draw-canvas" <!-- ä¿®æ­£: ãƒ©ã‚¤ãƒ–ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’å‚ç…§ -->
                width="2" 
                height="2" 
                position="0 1 0" 
                rotation="-90 0 0" 
                shadow="receive: true; cast: true"
                color="#FFFFFF"
                material="shader: standard; metalness: 0.1; roughness: 0.8; transparent: true; opacity: 1;"
            ></a-plane>
            <a-text 
                id="drawing-label"
                value="å…±åŒARã‚­ãƒ£ãƒ³ãƒã‚¹" 
                align="center" 
                position="0 2.1 0" 
                width="5"
                color="#E0E0E0"
                rotation="-90 0 0" 
            ></a-text>

        </a-entity>

        <!-- ã‚«ãƒ¡ãƒ©ã¨ãƒ©ã‚¤ãƒˆã®è¨­å®š -->
        <a-entity light="type: ambient; color: #BBB; intensity: 0.5;"></a-entity>
        <a-entity light="type: directional; color: #FFF; intensity: 0.8; target: #ar-drawing-plane;" position="-1 5 3"></a-entity>
        
        <!-- ARä½“é¨“ã®ãŸã‚ã®ã‚«ãƒ¡ãƒ©ã€‚AR.jsã«ã‚ˆã£ã¦è‡ªå‹•çš„ã«è¨­å®šã•ã‚Œã¾ã™ã€‚ -->
        <a-entity camera></a-entity>
    </a-scene>
    
    <!-- --- æç”»UIã‚’é–‹ããƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ --- -->
    <button id="toggle-drawing-button" title="æç”»UIã‚’é–‹ã">ğŸ¨</button>

    <!-- æç”»UIã‚¨ãƒªã‚¢ -->
    <div id="drawing-ui">
        <!-- --- é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ --- -->
        <button id="close-ui-button" title="é–‰ã˜ã‚‹">âœ•</button>

        <!-- ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã¯800x500ã‚’ç¶­æŒ -->
        <canvas id="draw-canvas" width="800" height="500"></canvas> 
        <div class="controls">
            <!-- æç”»ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆè‰²ã¨ã‚µã‚¤ã‚ºï¼‰ã‚’è¿½åŠ  -->
            <div class="drawing-options">
                <label for="color-picker" style="color: white; font-weight: bold; font-size: 0.9rem;">è‰²:</label>
                <input type="color" id="color-picker" value="#000000">
                
                <label for="brush-size-slider" style="color: white; font-weight: bold; font-size: 0.9rem;">å¤ªã•:</label>
                <input type="range" id="brush-size-slider" min="1" max="30" value="5">
                <span id="brush-size-value" style="color: #ccc; font-size: 0.9rem;">5</span>
            </div>
            
            <button id="save-button" class="control-button">ğŸ¨ ARç©ºé–“ã«åæ˜ ï¼†ä¿å­˜</button>
            <button id="clear-button" class="control-button">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
        </div>
        <p style="font-size: 0.75rem; color: #aaa; margin-top: 5px;">ã“ã®æç”»ã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨å…±æœ‰ã•ã‚Œã¾ã™</p>
    </div>

    <!-- æç”»ã¨ARåæ˜ ãƒ­ã‚¸ãƒƒã‚¯ -->
    <script>
        // æç”»é–¢é€£ã®DOMè¦ç´ 
        const drawCanvas = document.getElementById('draw-canvas');
        const saveButton = document.getElementById('save-button');
        const clearButton = document.getElementById('clear-button');
        // è¿½åŠ ã—ãŸã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
        const colorPicker = document.getElementById('color-picker');
        const brushSizeSlider = document.getElementById('brush-size-slider');
        const brushSizeValue = document.getElementById('brush-size-value');
        
        // --- UIé–‹é–‰é–¢é€£ã®DOMè¦ç´  ---
        const toggleButton = document.getElementById('toggle-drawing-button');
        const drawingUI = document.getElementById('drawing-ui');
        const closeUIButton = document.getElementById('close-ui-button');
        
        // ARãƒ†ã‚¯ã‚¹ãƒãƒ£ç”¨ã®è¦ç´ 
        // const arDrawingImg = document.getElementById('drawing-img'); // ä½¿ç”¨ã—ãªã„
        const arDrawingPlane = document.getElementById('ar-drawing-plane');
        const loadingMessage = document.getElementById('loading-message');

        let ctx = null; // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿æŒ
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let brushColor = colorPicker.value;
        let brushSize = parseInt(brushSizeSlider.value, 10);
        
        // UIãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’å³åº§ã«ã‚¢ã‚¿ãƒƒãƒ
        if (toggleButton) {
            toggleButton.addEventListener('click', () => {
                console.log("Toggle button clicked: Opening UI");
                toggleDrawingUI(true);
            });
        }

        // åˆæœŸåŒ–å‡¦ç†
        function setupDrawing() {
            // ã“ã“ã§ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
            if (drawCanvas.getContext) {
                ctx = drawCanvas.getContext('2d');
            } else {
                console.error("Canvas context not supported.");
                return;
            }
            
            // åˆæœŸæç”»
            clearCanvas(false); // åˆæœŸåŒ–æ™‚ã¯Firebaseã«ä¿å­˜ã—ãªã„
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            ctx.lineWidth = brushSize;
            ctx.strokeStyle = brushColor;
            brushSizeValue.textContent = brushSize; // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®åˆæœŸå€¤ã‚’è¡¨ç¤º

            // --- é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’ã“ã“ã§è¨­å®š ---
            if (closeUIButton) {
                closeUIButton.addEventListener('click', () => {
                    console.log("Close button clicked: Closing UI");
                    toggleDrawingUI(false);
                });
            }

            // ãƒã‚¦ã‚¹/ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            // Mouse events
            drawCanvas.addEventListener('mousedown', (e) => startDrawing(e));
            drawCanvas.addEventListener('mousemove', (e) => draw(e));
            document.addEventListener('mouseup', () => stopDrawing()); // ã‚­ãƒ£ãƒ³ãƒã‚¹å¤–ã§æŒ‡ã‚’é›¢ã—ã¦ã‚‚æç”»ã‚’æ­¢ã‚ã‚‹
            
            // Touch events
            drawCanvas.addEventListener('touchstart', (e) => {
                e.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²ã
                if (e.touches.length > 0) {
                    startDrawing(e.touches[0]); // TouchListã‹ã‚‰æœ€åˆã®Touchã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¸¡ã™
                }
            });
            drawCanvas.addEventListener('touchmove', (e) => {
                e.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²ã
                if (e.touches.length > 0) {
                    draw(e.touches[0]); // TouchListã‹ã‚‰æœ€åˆã®Touchã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¸¡ã™
                }
            });
            document.addEventListener('touchend', () => stopDrawing()); // ç”»é¢å¤–ã§æŒ‡ã‚’é›¢ã—ã¦ã‚‚æç”»ã‚’æ­¢ã‚ã‚‹
            document.addEventListener('touchcancel', () => stopDrawing()); // ç”»é¢å¤–ã§æŒ‡ã‚’é›¢ã—ã¦ã‚‚æç”»ã‚’æ­¢ã‚ã‚‹


            clearButton.addEventListener('click', () => clearCanvas(true)); // ã‚¯ãƒªã‚¢å¾Œã«ä¿å­˜
            saveButton.addEventListener('click', saveDrawing);
            
            // è‰²ã¨ã‚µã‚¤ã‚ºã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            colorPicker.addEventListener('input', (e) => {
                brushColor = e.target.value;
                ctx.strokeStyle = brushColor;
            });

            brushSizeSlider.addEventListener('input', (e) => {
                brushSize = parseInt(e.target.value, 10);
                ctx.lineWidth = brushSize;
                brushSizeValue.textContent = brushSize; // å€¤ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º
            });
        }
        
        // æç”»UIã®é–‹é–‰æ©Ÿèƒ½
        function toggleDrawingUI(shouldOpen) {
            if (shouldOpen) {
                drawingUI.classList.add('open');
                // UIã‚’é–‹ãã¨ãã¯ã€ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã‚’ä¸€æ™‚çš„ã«éš ã™
                toggleButton.style.display = 'none'; 
            } else {
                drawingUI.classList.remove('open');
                // UIã‚’é–‰ã˜ã‚‹ã¨ãã¯ã€ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹
                toggleButton.style.display = 'flex'; 
            }
        }


        // æç”»é–‹å§‹
        function startDrawing(e) {
            if (!ctx) return; // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãŒãªã„å ´åˆã¯æç”»ã—ãªã„
            isDrawing = true;
            
            const rect = drawCanvas.getBoundingClientRect();
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®è¡¨ç¤ºã‚µã‚¤ã‚ºã¨å†…éƒ¨ã‚µã‚¤ã‚ºã®é•ã„ã‚’è€ƒæ…®ã—ã¦åº§æ¨™ã‚’ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
            const scaleX = drawCanvas.width / rect.width;
            const scaleY = drawCanvas.height / rect.height;

            let clientX, clientY;

            // eãŒMouseEventã®å ´åˆ: offsetX/Yã‚’ä½¿ã† (ã‚­ãƒ£ãƒ³ãƒã‚¹å·¦ä¸Šã‹ã‚‰ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆ)
            if (e.offsetX !== undefined) {
                clientX = e.offsetX;
                clientY = e.offsetY;
            } 
            // eãŒTouchObjectã®å ´åˆ: clientX/Yã‚’ä½¿ã„ã€ã‚­ãƒ£ãƒ³ãƒã‚¹å·¦ä¸Šã‹ã‚‰ã®ç›¸å¯¾ä½ç½®ã‚’è¨ˆç®—
            else if (e.clientX !== undefined) {
                // çµ¶å¯¾åº§æ¨™ã‹ã‚‰ã‚­ãƒ£ãƒ³ãƒã‚¹ã®å·¦ä¸Šã®åº§æ¨™ã‚’å¼•ã„ã¦ç›¸å¯¾åº§æ¨™ã‚’æ±‚ã‚ã‚‹
                clientX = e.clientX - rect.left;
                clientY = e.clientY - rect.top;
            } else {
                isDrawing = false; // æœ‰åŠ¹ãªåº§æ¨™ãŒãªã„å ´åˆã¯æç”»ã‚’ä¸­æ­¢
                return;
            }

            // å®Ÿéš›ã®ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ã«ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
            const x = clientX * scaleX;
            const y = clientY * scaleY;

            [lastX, lastY] = [x, y];
            
            ctx.beginPath(); // æ–°ã—ã„ãƒ‘ã‚¹ã‚’é–‹å§‹
            ctx.moveTo(lastX, lastY);
        }

        // æç”»ä¸­
        function draw(e) {
            if (!isDrawing || !ctx) return;
            
            const rect = drawCanvas.getBoundingClientRect();
            
            const scaleX = drawCanvas.width / rect.width;
            const scaleY = drawCanvas.height / rect.height;

            let clientX, clientY;

            // eãŒMouseEventã®å ´åˆ
            if (e.offsetX !== undefined) {
                clientX = e.offsetX;
                clientY = e.offsetY;
            } 
            // eãŒTouchObjectã®å ´åˆ
            else if (e.clientX !== undefined) {
                clientX = e.clientX - rect.left;
                clientY = e.clientY - rect.top;
            } else {
                return; 
            }

            // å®Ÿéš›ã®ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ã«ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
            const x = clientX * scaleX;
            const y = clientY * scaleY;

            // æç”»ã¯startDrawingã§beginPathã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ã“ã“ã§ã¯ãƒ©ã‚¤ãƒ³ã‚’å¼•ãã ã‘
            ctx.lineTo(x, y);
            ctx.stroke();
            
            // æ¬¡ã®æç”»ã®ãŸã‚ã«åº§æ¨™ã‚’æ›´æ–°
            [lastX, lastY] = [x, y];
        }

        // æç”»çµ‚äº†
        function stopDrawing() {
            if (!isDrawing || !ctx) return;
            isDrawing = false;
            ctx.closePath();
            
            // æç”»ãŒå®Œäº†ã—ãŸæ™‚ç‚¹ã§ARãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚’æ›´æ–°ã—ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§çµæœã‚’å³åº§ã«ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ (ä¿®æ­£ç‚¹)
            updateARTexture(); 
        }

        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢
        function clearCanvas(shouldSave = false) {
            if (!ctx) return;
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, drawCanvas.width, drawCanvas.height);
            
            // ARç©ºé–“ã«ã‚‚åæ˜ ï¼ˆä¿å­˜å‡¦ç†ã¯åˆ¥ï¼‰
            updateARTexture();
            
            if (shouldSave) {
                saveDrawing(); // ã‚¯ãƒªã‚¢å¾Œã«Firestoreã«ç©ºã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä¿å­˜
            }
        }

        // ARãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚’æ›´æ–°
        function updateARTexture() {
            // A-Frameã®ãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚½ãƒ¼ã‚¹ã¯#draw-canvasãªã®ã§ã€canvasã®å¤‰æ›´ã‚’A-Frameã«é€šçŸ¥ã™ã‚‹ã ã‘ã§è‰¯ã„
            
            const material = arDrawingPlane.components.material;
            if (material && material.map) {
                // canvasã‚’ãƒ†ã‚¯ã‚¹ãƒãƒ£ã¨ã—ã¦ä½¿ã£ã¦ã„ã‚‹å ´åˆã€needsUpdateã‚’trueã«ã™ã‚‹ã ã‘ã§æ›´æ–°ã•ã‚Œã‚‹ (ä¿®æ­£ç‚¹)
                material.map.needsUpdate = true;
                console.log("AR Texture updated locally.");
            } else {
                 // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã¾ãŸã¯å†è¨­å®šãŒå¿…è¦ãªå ´åˆã€srcã‚’å†è¨­å®š
                 arDrawingPlane.setAttribute('material', 'src', '#draw-canvas');
                 console.log("AR Texture source set to #draw-canvas.");
            }
        }

        // Firebaseã¸ã®ä¿å­˜ã¨ARã¸ã®åæ˜ 
        async function saveDrawing() {
            if (!window.firebase || !window.firebase.db || !window.firebase.userId) {
                console.error("Firebase is not initialized or user ID is missing.");
                const statusMessage = document.createElement('div');
                statusMessage.textContent = 'ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼ã¨ã®æ¥ç¶šãŒç¢ºç«‹ã—ã¦ã„ã¾ã›ã‚“ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
                statusMessage.style.cssText = 'position: fixed; top: 10px; right: 10px; background: #f44336; color: white; padding: 10px; border-radius: 5px; z-index: 1001;';
                document.body.appendChild(statusMessage);
                setTimeout(() => statusMessage.remove(), 4000);
                return;
            }

            // ARãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚’æ›´æ–° (ãƒ­ãƒ¼ã‚«ãƒ«ã«åæ˜ )
            updateARTexture();
            
            // æç”»ãƒ‡ãƒ¼ã‚¿ã‚’Base64ã¨ã—ã¦å–å¾—
            const base64Image = drawCanvas.toDataURL('image/png');

            try {
                // Firestoreã¸ã®ä¿å­˜ãƒ‘ã‚¹ã‚’è¨­å®š
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                // Publicãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä¿å­˜ã—ã€å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§å…±æœ‰ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™
                const docRef = window.firebase.doc(window.firebase.db, 'artifacts', appId, 'public', 'data', 'ar_drawings', 'current_drawing');
                
                await window.firebase.setDoc(docRef, {
                    base64Image: base64Image,
                    artistId: window.firebase.userId,
                    timestamp: window.firebase.serverTimestamp(), // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã‚’ä½¿ç”¨
                    width: drawCanvas.width,
                    height: drawCanvas.height
                });
                
                console.log("Drawing successfully saved to Firestore.");
                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                const statusMessage = document.createElement('div');
                statusMessage.textContent = 'ä¿å­˜æˆåŠŸï¼ARç©ºé–“ã«åæ˜ ã•ã‚Œã¾ã—ãŸã€‚';
                statusMessage.style.cssText = 'position: fixed; top: 10px; right: 10px; background: #4CAF50; color: white; padding: 10px; border-radius: 5px; z-index: 1001;';
                document.body.appendChild(statusMessage);
                setTimeout(() => statusMessage.remove(), 4000);
            } catch (e) {
                console.error("Error saving document: ", e);
                // ã‚«ã‚¹ã‚¿ãƒ UIã§ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
                const statusMessage = document.createElement('div');
                statusMessage.textContent = 'ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                statusMessage.style.cssText = 'position: fixed; top: 10px; right: 10px; background: #f44336; color: white; padding: 10px; border-radius: 5px; z-index: 1001;';
                document.body.appendChild(statusMessage);
                setTimeout(() => statusMessage.remove(), 4000);
            }
        }
        
        // Firestoreã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ç›£è¦–
        function startFirestoreListener() {
            if (!window.firebase || !window.firebase.db) {
                console.error("Firestore DB is not available for listener setup.");
                return;
            }
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã‚’ä½¿ç”¨
            const colRef = window.firebase.collection(window.firebase.db, 'artifacts', appId, 'public', 'data', 'ar_drawings');
            const docRef = window.firebase.doc(colRef, 'current_drawing');

            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š (ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã‚’ä½¿ç”¨)
            window.firebase.onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const base64Image = data.base64Image;
                    
                    // è‡ªåˆ†ã§ä¿å­˜ã—ãŸãƒ‡ãƒ¼ã‚¿ã¯ç„¡è¦–ã™ã‚‹ï¼ˆFirestoreå´ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒãªã„ãŸã‚å³å¯†ãªãƒã‚§ãƒƒã‚¯ã¯ã§ããªã„ãŒã€ã“ã“ã§ã¯å…¨ã¦ã®æ›´æ–°ã‚’å—ã‘å…¥ã‚Œã‚‹ï¼‰
                    // if (data.artistId === window.firebase.userId) return; 
                    
                    if (base64Image) {
                        console.log("New drawing received from Firestore. Artist:", data.artistId);
                        
                        // ç”»åƒã‚’ä¸€æ—¦imgè¦ç´ ã«ãƒ­ãƒ¼ãƒ‰ã—ã€ãã‚ŒãŒãƒ­ãƒ¼ãƒ‰å®Œäº†ã—ãŸã‚‰Canvasã«æç”»
                        const tempImg = new Image();
                        tempImg.onload = () => {
                            // å—ä¿¡ã—ãŸç”»åƒã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã®æç”»ã‚­ãƒ£ãƒ³ãƒã‚¹ã«åæ˜ 
                            // NOTE: å—ä¿¡ã—ãŸãƒ‡ãƒ¼ã‚¿ãŒç¾åœ¨ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã¨ç•°ãªã£ã¦ã‚‚ã€fitã•ã›ã‚‹
                            if (ctx) {
                                ctx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
                                ctx.drawImage(tempImg, 0, 0, drawCanvas.width, drawCanvas.height);
                                // ARãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚‚æ›´æ–°
                                updateARTexture(); 
                            }
                        };
                        tempImg.onerror = () => {
                            console.error("Failed to load received base64 image.");
                        };
                        tempImg.src = base64Image;
                    }
                } else {
                    console.log("No collaborative drawing found. Initializing local canvas.");
                    clearCanvas(false); // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ã‚¯ãƒªã‚¢ã®ã¿ï¼ˆä¿å­˜ã¯ã—ãªã„ï¼‰
                }
            }, (error) => {
                console.error("Error listening to Firestore: ", error);
            });
        }


        // AR.jsãŒã‚·ãƒ¼ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‰å®Œäº†ã—ãŸã‚‰ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤ºã«ã™ã‚‹
        document.querySelector('a-scene').addEventListener('arjs-original-contents-loaded', function () {
            // AR.jsãŒæˆåŠŸã—ãŸå ´åˆ
            loadingMessage.style.opacity = '0';
            setTimeout(() => { loadingMessage.style.display = 'none'; }, 500); // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆå¾Œã«éè¡¨ç¤º
            console.log("AR.js content loaded successfully.");
            // ã‚«ãƒ¡ãƒ©è¨±å¯ãŒé…å»¶ã—ãŸå ´åˆã«å‚™ãˆã¦ã€ARãƒ­ãƒ¼ãƒ‰å¾Œã«UIã‚‚ç¢ºèª
            if (window.initApp) {
                window.initApp();
            }
        });

        // ARåˆæœŸåŒ–å¤±æ•—æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
        // 8ç§’çµŒã£ã¦ã‚‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ¶ˆãˆãªã„å ´åˆã€æ‰‹å‹•ã§éè¡¨ç¤ºã«ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ“ä½œã•ã›ã‚‹
        setTimeout(() => {
            if (loadingMessage.style.opacity !== '0') {
                loadingMessage.style.opacity = '0';
                setTimeout(() => { loadingMessage.style.display = 'none'; }, 500);
                console.warn("AR content load event timed out. Allowing user interaction.");
            }
        }, 8000); 

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
        window.initApp = function() {
            if (!ctx) { // å¤šé‡åˆæœŸåŒ–é˜²æ­¢
                setupDrawing();
                startFirestoreListener();
                updateARTexture(); // åˆæœŸãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚’ã‚»ãƒƒãƒˆ
                // ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã¯UIã‚’é–‰ã˜ãŸçŠ¶æ…‹ã«ã™ã‚‹
                toggleDrawingUI(false); 
            }
        }

        // Firebaseã®èªè¨¼æº–å‚™ãŒæ•´ã†ã¾ã§å¾…ã¤ï¼ˆä¸Šè¨˜type="module"ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã§ã‚³ãƒ¼ãƒ«ã•ã‚Œã‚‹ï¼‰
        // NOTE: Firebaseã®èªè¨¼å¾Œã«initApp()ãŒå‘¼ã°ã‚Œã‚‹ã“ã¨ã‚’å‰æã¨ã™ã‚‹
    </script>
    
</body>
</html>
